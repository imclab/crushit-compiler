define(["./console"],function(e){var t=Backbone.View.extend({el:$("#left-panel"),active:!1,showingError:!1,terminalHandle:null,events:{"submit #crushit":"crushIt","focus #url":"onUrlFocus","blur #url":"onUrlBlur","change #max":"onOptionsChange","change #comments":"onOptionsChange","change #beautify":"onOptionsChange"},initialize:function(){this.console=new e,this.listenTo(this,"init",this.init),this.listenTo(this,"loading",this.loading),this.listenTo(this,"loaded",this.loaded),this.listenTo(this,"error",this.onError),this.blink()},crushIt:function(){if(this.active)return;this.trigger("init");var e=this,t=e.$("#url").val(),n=e.$("#crushit").serialize();return e.switchOfBlinker(),e.runTerminal(t,function(){e.trigger("loading"),e.sendRequest("/crush",n,"text",t)}),!1},sendRequest:function(e,t,n,r){var i=this;$.post(e,t,n).done(function(e){i.console.update(e),i.trigger("loaded")}).fail(function(e){i.trigger("error"),i.console.update(e.responseText)})},loading:function(){this.showingError&&($("#console").removeClass("error"),this.showingError=!1),this.console.update("Crushing scripts...."),$("#loading").removeClass("loading-inactive").addClass("loading-active"),this.active=!0},init:function(){this.$("#submit").addClass("disabled").attr("disabled","disabled"),this.active=!0},loaded:function(){this.reset()},reset:function(){this.$("#submit").removeClass("disabled").attr("disabled",!1),$("#loading").removeClass("loading-active").addClass("loading-inactive"),this.active=!1},onError:function(){$("#console").addClass("error"),this.showingError=!0,this.reset()},onUrlFocus:function(){if(!!this.active)return;this.$("#url").val(""),this.console.update(""),this.switchOfBlinker()},onUrlBlur:function(){!$("#url").val()&&!this.active&&this.blink()},onOptionsChange:function(){$("#max").is(":checked")&&this.$("#comments, #beautify").attr("checked",!1)},runTerminal:function(e,t){var n=this.getCommand(e),r=this.$("#crushit-command");r.text(""),$({count:0}).animate({count:n.length},{duration:2e3,step:function(){r.text(n.substring(0,Math.round(this.count)))}}).promise().done(t)},getCommand:function(e){var t="crushit ";return $("#max").is(":checked")?t+="-m "+e:$("#beautify").is(":checked")&&$("#comments").is(":checked")?t+="-bc "+e:$("#beautify").is(":checked")?t+="-b "+e:$("#comments").is(":checked")?t+="-c "+e:t+=e},blink:function(){var e=this,t=this.$("#crushit-command"),n=!1;e.terminalHandle=window.setInterval(function(){n?(t.text(""),n=!1):(t.text("_"),n=!0)},500)},switchOfBlinker:function(){window.clearInterval(this.terminalHandle),this.terminalHandle=null,this.$("#crushit-command").text("")}});return t});